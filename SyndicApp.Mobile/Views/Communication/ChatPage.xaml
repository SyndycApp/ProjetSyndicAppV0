<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SyndicApp.Mobile.Views.Communication.ChatPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:SyndicApp.Mobile.ViewModels.Communication"
    xmlns:conv="clr-namespace:SyndicApp.Mobile.Converters"
    xmlns:models="clr-namespace:SyndicApp.Mobile.Models"
    x:DataType="vm:ChatViewModel"
    x:Name="RootPage"
    Shell.NavBarIsVisible="False"
    BackgroundColor="#F3F4F6">

    <!-- ===================== RESOURCES ===================== -->
    <ContentPage.Resources>
        <conv:BubbleAlignmentConverter x:Key="BubbleAlignmentConverter" />
        <conv:BubbleColorConverter x:Key="BubbleColorConverter" />
        <conv:MessageSeenIconConverter x:Key="MessageSeenIconConverter" />
        <conv:PlayPauseIconConverter x:Key="PlayPauseIconConverter" />
        <conv:WaveBarColorConverter x:Key="WaveBarColorConverter" />
        <conv:IntToBoolConverter x:Key="IntToBoolConverter" />
        <conv:ReactionCommandParamConverter x:Key="ReactionCommandParamConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- ===================== HEADER ===================== -->
        <Grid BackgroundColor="#2563EB"
              Padding="16"
              HeightRequest="60"
              ColumnDefinitions="40,*">

            <ImageButton
                Source="arrow_back_white.png"
                WidthRequest="28"
                HeightRequest="28"
                BackgroundColor="Transparent"
                Clicked="OnBackClicked" />

            <Label Grid.Column="1"
                   Text="{Binding NomDestinataire}"
                   FontSize="20"
                   TextColor="White"
                   FontAttributes="Bold"
                   VerticalOptions="Center" />
        </Grid>

        <!-- ===================== MESSAGES ===================== -->
        <ScrollView Grid.Row="1" x:Name="MessagesScrollView" Padding="10">
            <VerticalStackLayout
                Spacing="8"
                x:Name="MessagesStack"
                BindableLayout.ItemsSource="{Binding Messages}">

                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:MessageDto">

                        <Frame
                            CornerRadius="14"
                            Padding="10"
                            HasShadow="False"
                            MaximumWidthRequest="280"
                            BackgroundColor="{Binding UserId, Converter={StaticResource BubbleColorConverter}}"
                            HorizontalOptions="{Binding UserId, Converter={StaticResource BubbleAlignmentConverter}}">

                            <VerticalStackLayout Spacing="6">

                                <!-- TEXTE -->
                                <Label Text="{Binding Contenu}"
                                       FontSize="16"
                                       TextColor="Black"
                                       IsVisible="{Binding IsText}" />

                                <!-- IMAGE -->
                                <Border IsVisible="{Binding IsImage}"
                                        HeightRequest="180"
                                        WidthRequest="240"
                                        Margin="0,4">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12"/>
                                    </Border.StrokeShape>
                                    <Image Source="{Binding AbsoluteFileUrl}"
                                           Aspect="AspectFill"/>
                                </Border>

                                <!-- DOCUMENT -->
                                <Frame IsVisible="{Binding IsDocument}"
                                       Padding="10"
                                       CornerRadius="10"
                                       BackgroundColor="#E5E7EB">
                                    <HorizontalStackLayout Spacing="10">
                                        <Image Source="document_icon.png"
                                               WidthRequest="28"
                                               HeightRequest="28"/>
                                        <VerticalStackLayout>
                                            <Label Text="{Binding FileName}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"/>
                                            <Label Text="{Binding ContentType}"
                                                   FontSize="11"
                                                   TextColor="#6B7280"/>
                                        </VerticalStackLayout>
                                        <ImageButton Source="download.png"
                                                     WidthRequest="32"
                                                     HeightRequest="32"
                                                     BackgroundColor="Transparent"
                                                     Command="{Binding BindingContext.OpenFileCommand, Source={x:Reference RootPage}}"
                                                     CommandParameter="{Binding .}" />
                                    </HorizontalStackLayout>
                                </Frame>
                                 <!-- LOCATION -->
                               <Frame IsVisible="{Binding IsLocation}"
       Padding="0"
       CornerRadius="12"
       HasShadow="False"
       BackgroundColor="#DBEAFE"
       WidthRequest="240">

    <Grid RowDefinitions="Auto,Auto">

        <!-- MAP IMAGE -->
        <Image Source="{Binding StaticMapUrl}"
               HeightRequest="160"
               Aspect="AspectFill"
               BackgroundColor="#E5E7EB">

            <Image.GestureRecognizers>
                <TapGestureRecognizer
                    Command="{Binding BindingContext.OpenMapCommand, Source={x:Reference RootPage}}"
                    CommandParameter="{Binding ExternalMapUrl}" />
            </Image.GestureRecognizers>

        </Image>

        <!-- FOOTER -->
        <Grid Grid.Row="1"
              Padding="8"
              ColumnDefinitions="Auto,*">

            <Image Source="location_pin.png"
                   WidthRequest="18"
                   HeightRequest="18"
                   VerticalOptions="Center"/>

            <Label Grid.Column="1"
                   Text="Position partagÃ©e"
                   FontSize="12"
                   TextColor="#1E3A8A"
                   VerticalOptions="Center"/>

        </Grid>

    </Grid>
</Frame>
<!-- ===================== AUDIO WAVES ===================== -->
                                <Grid IsVisible="{Binding IsAudio}"
      ColumnDefinitions="Auto,*"
      RowDefinitions="Auto,Auto"
      ColumnSpacing="10">

    <!-- PLAY / PAUSE -->
    <ImageButton
        Source="{Binding IsPlaying, Converter={StaticResource PlayPauseIconConverter}}"
        WidthRequest="32"
        HeightRequest="32"
        Padding="6"
        Aspect="AspectFit"
        BackgroundColor="Transparent"
        Command="{Binding BindingContext.PlayAudioCommand, Source={x:Reference RootPage}}"
        CommandParameter="{Binding .}" />

    <!-- WAVES -->
    <HorizontalStackLayout Grid.Column="1"
                           Spacing="3"
                           VerticalOptions="Center"
                           BindableLayout.ItemsSource="{Binding Waveform}">

        <BindableLayout.ItemTemplate>
            <DataTemplate>
                <BoxView WidthRequest="3"
                         HeightRequest="18"
                         CornerRadius="2"
                         Color="{Binding Source={RelativeSource AncestorType={x:Type models:MessageDto}},
                                         Path=AudioProgress,
                                         Converter={StaticResource WaveBarColorConverter},
                                         ConverterParameter={Binding .}}" />
            </DataTemplate>
        </BindableLayout.ItemTemplate>

    </HorizontalStackLayout>

    <!-- TIME -->
    <Label Grid.Row="1"
           Grid.ColumnSpan="2"
           FontSize="11"
           TextColor="#6B7280"
           Text="{Binding AudioTime}" />
</Grid>
<!-- ===================== REACTION BUTTONS ===================== -->
<HorizontalStackLayout Spacing="6" Margin="0,4,0,0">

    <Label Text="ðŸ‘" FontSize="18">
        <Label.GestureRecognizers>
            <TapGestureRecognizer
                Command="{Binding BindingContext.ReactCommand, Source={x:Reference RootPage}}"
                CommandParameter="{Binding ., Converter={StaticResource ReactionCommandParamConverter}, ConverterParameter=ðŸ‘}" />
        </Label.GestureRecognizers>
    </Label>

    <Label Text="â¤ï¸" FontSize="18">
        <Label.GestureRecognizers>
            <TapGestureRecognizer
                Command="{Binding BindingContext.ReactCommand, Source={x:Reference RootPage}}"
                CommandParameter="{Binding ., Converter={StaticResource ReactionCommandParamConverter}, ConverterParameter=â¤ï¸}" />
        </Label.GestureRecognizers>
    </Label>

    <Label Text="ðŸ˜‚" FontSize="18">
        <Label.GestureRecognizers>
            <TapGestureRecognizer
                Command="{Binding BindingContext.ReactCommand, Source={x:Reference RootPage}}"
                CommandParameter="{Binding ., Converter={StaticResource ReactionCommandParamConverter}, ConverterParameter=ðŸ˜‚}" />
        </Label.GestureRecognizers>
    </Label>

</HorizontalStackLayout>
                                <!-- ===================== GROUPED REACTIONS ===================== -->
                                <HorizontalStackLayout
                                    Spacing="4"
                                    Margin="0,2,0,0"
                                    IsVisible="{Binding HasGroupedReactions}"
                                    BindableLayout.ItemsSource="{Binding GroupedReactions}">

                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:MessageReactionGroupDto">
                                            <Frame Padding="3,1"
                                                   CornerRadius="10"
                                                   BackgroundColor="#F1F5F9"
                                                   HasShadow="False">
                                                <HorizontalStackLayout Spacing="2">
                                                    <Label Text="{Binding Emoji}" FontSize="12"/>
                                                    <Label Text="{Binding Count}"
                                                           FontSize="10"
                                                           FontAttributes="Bold"
                                                           TextColor="#374151"/>
                                                </HorizontalStackLayout>
                                            </Frame>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>

                                </HorizontalStackLayout>

                                <!-- META -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding CreatedAt, StringFormat='{0:HH:mm}'}"
                                           FontSize="12"
                                           TextColor="#6B7280"/>
                                    <Image Grid.Column="1"
                                           WidthRequest="18"
                                           HeightRequest="18"
                                           Source="{Binding IsRead, Converter={StaticResource MessageSeenIconConverter}}"/>
                                </Grid>

                            </VerticalStackLayout>
                        </Frame>

                    </DataTemplate>
                </BindableLayout.ItemTemplate>

            </VerticalStackLayout>
        </ScrollView>

        <!-- ===================== INPUT BAR ===================== -->
        <Grid Grid.Row="2"
              Padding="12"
              BackgroundColor="White"
              ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto">

            <Frame CornerRadius="20"
                   BackgroundColor="#F0F0F0"
                   Padding="12">
                <Entry Text="{Binding NewMessage}"
                       Placeholder="Ã‰crire un messageâ€¦"
                       FontSize="16"
                       TextColor="#111827"
                       PlaceholderColor="#9CA3AF"
                       BackgroundColor="Transparent"/>
            </Frame>

            <ImageButton Grid.Column="1"
                         Source="image.png"
                         WidthRequest="44"
                         HeightRequest="44"
                         Padding="8"
                         Aspect="AspectFit"
                         BackgroundColor="Transparent"
                         Command="{Binding SendImageCommand}" />

            <ImageButton Grid.Column="2"
                         Source="attachment.png"
                         WidthRequest="44"
                         HeightRequest="44"
                         Padding="8"
                         Aspect="AspectFit"
                         BackgroundColor="Transparent"
                         Command="{Binding SendDocumentCommand}" />

            <ImageButton Grid.Column="3"
                         Source="location_pin.png"
                         WidthRequest="44"
                         HeightRequest="44"
                         Padding="8"
                         Aspect="AspectFit"
                         BackgroundColor="Transparent"
                         Command="{Binding SendLocationCommand}" />

            <ImageButton Grid.Column="4"
                         Source="micro.png"
                         WidthRequest="44"
                         HeightRequest="44"
                         Padding="8"
                         Aspect="AspectFit"
                         BackgroundColor="Transparent"
                         Command="{Binding ToggleRecordingCommand}" />

            <ImageButton Grid.Column="5"
                         Source="send_icon.png"
                         WidthRequest="44"
                         HeightRequest="44"
                         Padding="8"
                         Aspect="AspectFit"
                         BackgroundColor="Transparent"
                         Command="{Binding SendMessageCommand}" />
        </Grid>
    </Grid>
</ContentPage>
