<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="SyndicApp.Mobile.Views.Finances.ChargesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:SyndicApp.Mobile.ViewModels.Finances"
    xmlns:models="clr-namespace:SyndicApp.Mobile.Models"
    xmlns:layout="clr-namespace:SyndicApp.Mobile.Views.Layout"
    x:Name="ChargesPageRoot"
    x:DataType="viewmodels:ChargesListViewModel"
    Title="Charges"
    Shell.NavBarIsVisible="False"
    BackgroundColor="White">

    <ContentPage.Resources>
        <Color x:Key="TopbarColor">#2563EB</Color>
        <Color x:Key="HeaderTextOnDark">#FFFFFF</Color>
        <Color x:Key="BodyText">#111827</Color>
        <Color x:Key="Divider">#E5E7EB</Color>
        <Color x:Key="Chip">#F3F4F6</Color>

        <Style TargetType="Label">
            <Setter Property="TextColor" Value="{StaticResource BodyText}" />
        </Style>

        <Style TargetType="Button" x:Key="SecondaryActionButton">
            <Setter Property="BackgroundColor" Value="Transparent" />
            <Setter Property="TextColor" Value="{StaticResource BodyText}" />
            <Setter Property="FontAttributes" Value="Bold" />
        </Style>
    </ContentPage.Resources>

    <!-- ✅ Utilise le RoleDrawerLayout global -->
    <layout:RoleDrawerLayout>
        <layout:RoleDrawerLayout.MainContent>

            <Grid RowDefinitions="Auto,*"
                  Padding="16,8,16,16"
                  BackgroundColor="White">

                <!-- En-tête local page Charges -->
                <Grid Grid.Row="0"
                      ColumnDefinitions="*,Auto"
                      Margin="0,0,0,8">
                    <Label Text="Charges"
                           FontAttributes="Bold"
                           FontSize="20"
                           VerticalOptions="Center" />

                    <!-- Bouton + restreint par rôle -->
                    <Button Grid.Column="1"
                            Text="+"
                            FontSize="22"
                            Style="{StaticResource SecondaryActionButton}"
                            Command="{Binding NewChargeCommand}"
                            IsVisible="{Binding CanManageCharges}" />
                </Grid>

                <!-- Liste -->
                <Grid Grid.Row="1">
                    <RefreshView IsRefreshing="{Binding IsBusy}"
                                 Command="{Binding LoadCommand}">
                        <CollectionView ItemsSource="{Binding Charges}">
                            <CollectionView.EmptyView>
                                <StackLayout Padding="20"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center">
                                    <Label Text="Aucune charge pour le moment." />
                                </StackLayout>
                            </CollectionView.EmptyView>

                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:ChargeDto">
                                    <SwipeView
                                        IsEnabled="{Binding Source={x:Reference ChargesPageRoot},
                                                            Path=BindingContext.CanManageCharges}">
                                        <SwipeView.RightItems>
                                            <SwipeItems Mode="Execute">
                                                <SwipeItem Text="Modifier"
                                                           BackgroundColor="#2563EB"
                                                           Command="{Binding BindingContext.EditCommand, Source={x:Reference ChargesPageRoot}}"
                                                           CommandParameter="{Binding .}" />
                                                <SwipeItem Text="Supprimer"
                                                           BackgroundColor="Red"
                                                           Command="{Binding BindingContext.DeleteCommand, Source={x:Reference ChargesPageRoot}}"
                                                           CommandParameter="{Binding .}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>

                                        <Frame Margin="0,4"
                                               Padding="12"
                                               HasShadow="False"
                                               BorderColor="#1F4CA3"
                                               CornerRadius="12">
                                            <Grid ColumnDefinitions="*,Auto"
                                                  RowDefinitions="Auto,Auto">

                                                <Label Grid.Row="0"
                                                       Grid.Column="0"
                                                       Text="{Binding Nom}"
                                                       FontAttributes="Bold" />

                                                <Label Grid.Row="0"
                                                       Grid.Column="1"
                                                       Text="{Binding Montant, StringFormat='{}{0:F2} MAD'}"
                                                       HorizontalTextAlignment="End"
                                                       FontAttributes="Bold" />

                                                <Label Grid.Row="1"
                                                       Grid.Column="0"
                                                       Text="{Binding DateCharge, StringFormat='Le {0:dd/MM/yyyy}'}"
                                                       FontSize="12"
                                                       Opacity="0.7" />

                                                <Label Grid.Row="1"
                                                       Grid.Column="1"
                                                       Text="{Binding ResidenceNom}"
                                                       FontSize="12"
                                                       HorizontalTextAlignment="End"
                                                       Opacity="0.7" />
                                            </Grid>

                                            <!-- Tap = détails -->
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={x:Reference ChargesPageRoot}, Path=BindingContext.OpenDetailsCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </Frame.GestureRecognizers>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </RefreshView>
                </Grid>
            </Grid>

        </layout:RoleDrawerLayout.MainContent>
    </layout:RoleDrawerLayout>
</ContentPage>
